/**
 * Gmail SMTP Test Script
 * 
 * This script tests the Gmail SMTP configuration to verify email sending works
 * Run with: node test-gmail-smtp.js
 */

const nodemailer = require('nodemailer');

async function testGmailSMTP() {
    console.log('üß™ Testing Gmail SMTP Configuration...\n');
    
    // Load environment variables
    const gmailUser = process.env.GMAIL_USER || 'your-gmail@gmail.com';
    const gmailPassword = process.env.GMAIL_APP_PASSWORD || 'your-app-password';
    
    console.log('üìã Configuration:');
    console.log(`   Gmail User: ${gmailUser}`);
    console.log(`   App Password Length: ${gmailPassword.length} characters`);
    console.log(`   Expected Length: 16 characters`);
    console.log('');
    
    if (gmailPassword.length !== 16) {
        console.error('‚ùå ERROR: Gmail App Password should be exactly 16 characters');
        console.error('   Current length:', gmailPassword.length);
        console.error('   Please check your app password format');
        return;
    }
    
    // Create transporter
    const transporter = nodemailer.createTransport({
        service: 'gmail',
        auth: {
            user: gmailUser,
            pass: gmailPassword
        }
    });
    
    try {
        // Test SMTP connection
        console.log('üîç Testing SMTP connection...');
        await transporter.verify();
        console.log('‚úÖ SMTP connection verified successfully!\n');
        
        // Send test email
        console.log('üìß Sending test email...');
        const testEmailOptions = {
            from: `"CA-66 Test System" <${gmailUser}>`,
            to: gmailUser, // Send to self for testing
            cc: 'kaufman@airspaceintegration.com',
            subject: 'CA-66 Email System Test - ' + new Date().toLocaleString(),
            html: `
                <h2>üß™ Email System Test</h2>
                <p>This is a test email from the CA-66 Airport Agreement system.</p>
                <p><strong>Test Details:</strong></p>
                <ul>
                    <li>Timestamp: ${new Date().toISOString()}</li>
                    <li>Gmail User: ${gmailUser}</li>
                    <li>SMTP Service: Gmail</li>
                    <li>Status: ‚úÖ Working correctly</li>
                </ul>
                <p>If you receive this email, the Gmail SMTP configuration is working properly!</p>
                <hr>
                <small>Generated by test-gmail-smtp.js</small>
            `,
            text: `
CA-66 Email System Test

This is a test email from the CA-66 Airport Agreement system.

Test Details:
- Timestamp: ${new Date().toISOString()}
- Gmail User: ${gmailUser}
- SMTP Service: Gmail
- Status: ‚úÖ Working correctly

If you receive this email, the Gmail SMTP configuration is working properly!
            `
        };
        
        const result = await transporter.sendMail(testEmailOptions);
        
        console.log('‚úÖ Test email sent successfully!');
        console.log('   Message ID:', result.messageId);
        console.log('   Response:', result.response);
        console.log('');
        console.log('üéâ Gmail SMTP configuration is working correctly!');
        console.log('üì¨ Check your email inbox for the test message.');
        
    } catch (error) {
        console.error('‚ùå Gmail SMTP Test Failed:');
        console.error('   Error:', error.message);
        console.error('   Code:', error.code);
        console.error('   Response Code:', error.responseCode);
        console.error('');
        
        // Provide specific troubleshooting
        if (error.message.includes('Invalid login')) {
            console.error('üîß Troubleshooting:');
            console.error('   1. Check your Gmail app password is correct');
            console.error('   2. Ensure 2-Factor Authentication is enabled');
            console.error('   3. Regenerate app password if needed');
            console.error('   4. Make sure password has no spaces');
        } else if (error.code === 'ENOTFOUND') {
            console.error('üîß Troubleshooting:');
            console.error('   1. Check your internet connection');
            console.error('   2. Verify Gmail service is accessible');
        } else {
            console.error('üîß Troubleshooting:');
            console.error('   1. Check the error message above');
            console.error('   2. Verify all credentials are correct');
            console.error('   3. Review Gmail SMTP setup guide');
        }
    }
}

// Run the test
testGmailSMTP().catch(console.error);