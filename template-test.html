<!DOCTYPE html>
<html>
<head>
    <title>CA-66 Template Test</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; }
        .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .warning { background: #fff3cd; color: #856404; }
        .info { background: #d1ecf1; color: #0c5460; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
        #log { background: #f8f9fa; padding: 15px; border: 1px solid #dee2e6; border-radius: 4px; height: 400px; overflow-y: auto; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
    </style>
</head>
<body>
    <h1>üîß CA-66 PDF Template Testing</h1>
    
    <div id="status" class="status info">
        Loading PDF libraries and modules...
    </div>
    
    <button onclick="testFillableTemplate()">üîç Test Fillable Template</button>
    <button onclick="testPDFGeneration()">üöÄ Test PDF Generation</button>
    <button onclick="clearLog()">üßπ Clear Log</button>
    
    <div id="log"></div>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script type="module">
        import { PDFFiller } from './assets/js/pdf-filler.js';
        import { PDFLibGenerator } from './assets/js/pdf-lib-generator.js';
        import { DateCalculator } from './assets/js/calculator.js';

        // Make modules available globally
        window.PDFFiller = PDFFiller;
        window.PDFLibGenerator = PDFLibGenerator;
        window.DateCalculator = DateCalculator;
        
        // Test data
        window.testData = {
            'licensee-name': 'John Pilot Test',
            'company-name': 'Test Aviation LLC',
            'phone': '(555) 123-4567',
            'email': 'john@testaviation.com',
            'flight-hours': 350,
            'aircraft-registration': 'N12345',
            'aircraft-make-model': 'Cessna 172',
            'insurance-company': 'Aviation Insurance Co.',
            'insurance-address': '123 Insurance Way',
            'insurance-city': 'San Francisco',
            'insurance-state': 'CA',
            'insurance-zip': '94105',
            'insurance-phone': '(555) 987-6543',
            'policy-number': 'TEST-2025-001',
            'policy-expiry': '2025-12-31',
            'coverage-amount': 1000000,
            'start-date': '2025-01-15',
            'end-date': '2026-01-15'
        };

        // Update status when modules are loaded
        document.getElementById('status').innerHTML = '‚úÖ All modules loaded successfully!';
        document.getElementById('status').className = 'status success';
    </script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        async function testFillableTemplate() {
            log('Testing fillable PDF template...', 'info');
            
            try {
                // Test if fillable template exists and has form fields
                const response = await fetch('assets/examples/CA66-Agreement-Form.pdf');
                if (!response.ok) {
                    log(`Fillable template not found (${response.status})`, 'warning');
                    log('System will use text overlay fallback', 'info');
                    return;
                }

                const bytes = await response.arrayBuffer();
                log(`Template loaded: ${Math.round(bytes.byteLength / 1024)}KB`, 'success');

                // Analyze with pdf-lib
                const pdfDoc = await PDFLib.PDFDocument.load(bytes);
                const form = pdfDoc.getForm();
                const fields = form.getFields();

                log(`PDF contains ${pdfDoc.getPageCount()} pages`, 'info');
                log(`Form fields found: ${fields.length}`, fields.length > 0 ? 'success' : 'warning');

                if (fields.length > 0) {
                    log('Available form fields:', 'info');
                    fields.forEach((field, i) => {
                        const name = field.getName();
                        const type = field.constructor.name.replace('PDF', '');
                        log(`  ${i + 1}. "${name}" (${type})`, 'info');
                    });

                    // Test field compatibility
                    const pdfData = window.PDFFiller.preparePDFData(window.testData);
                    const fieldNames = fields.map(f => f.getName());
                    
                    log('Testing field compatibility...', 'info');
                    let matches = 0;
                    let mismatches = [];

                    Object.keys(pdfData).forEach(dataKey => {
                        // Try various field name formats
                        const variations = [
                            dataKey,
                            dataKey.toLowerCase(),
                            dataKey.toUpperCase(),
                            dataKey.replace(/[-_]/g, ' '),
                            dataKey.replace(/[-_]/g, ''),
                            dataKey.replace(/\s/g, '-'),
                            dataKey.replace(/\s/g, '_')
                        ];

                        const found = variations.some(variation => fieldNames.includes(variation));
                        if (found) {
                            matches++;
                            log(`  ‚úÖ Match: ${dataKey}`, 'success');
                        } else {
                            mismatches.push(dataKey);
                        }
                    });

                    if (mismatches.length > 0) {
                        log('Fields without matches:', 'warning');
                        mismatches.forEach(field => log(`  ‚ùå ${field}`, 'warning'));
                    }

                    const matchRate = Math.round((matches / Object.keys(pdfData).length) * 100);
                    log(`Field compatibility: ${matches}/${Object.keys(pdfData).length} (${matchRate}%)`, matchRate > 50 ? 'success' : 'warning');

                    if (matches > 0) {
                        log('‚úÖ Template is compatible with fillable form approach!', 'success');
                    } else {
                        log('‚ö†Ô∏è No field matches - will use text overlay fallback', 'warning');
                    }
                } else {
                    log('No form fields detected - template needs form field creation', 'warning');
                }

            } catch (error) {
                log(`Template analysis failed: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function testPDFGeneration() {
            log('Starting PDF generation test...', 'info');
            
            try {
                const startTime = performance.now();
                
                // Use our improved PDF generation system
                const pdfBytes = await window.PDFLibGenerator.generateFilledPDF(window.testData);
                
                const endTime = performance.now();
                const duration = endTime - startTime;

                log(`‚úÖ PDF generated successfully!`, 'success');
                log(`File size: ${Math.round(pdfBytes.length / 1024)}KB`, 'info');
                log(`Generation time: ${duration.toFixed(2)}ms`, duration < 3000 ? 'success' : 'warning');

                // Create download link
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                const downloadLink = document.createElement('a');
                downloadLink.href = url;
                downloadLink.download = 'test-fillable-pdf.pdf';
                downloadLink.textContent = 'üíæ Download Generated PDF';
                downloadLink.style.display = 'block';
                downloadLink.style.margin = '10px 0';
                downloadLink.style.padding = '10px';
                downloadLink.style.background = '#007bff';
                downloadLink.style.color = 'white';
                downloadLink.style.textDecoration = 'none';
                downloadLink.style.borderRadius = '4px';
                
                const previewLink = document.createElement('a');
                previewLink.href = url;
                previewLink.target = '_blank';
                previewLink.textContent = 'üëÄ Preview PDF';
                previewLink.style.display = 'block';
                previewLink.style.margin = '10px 0';
                previewLink.style.padding = '10px';
                previewLink.style.background = '#28a745';
                previewLink.style.color = 'white';
                previewLink.style.textDecoration = 'none';
                previewLink.style.borderRadius = '4px';

                document.body.appendChild(downloadLink);
                document.body.appendChild(previewLink);

                log('‚úÖ Test completed successfully!', 'success');

            } catch (error) {
                log(`PDF generation failed: ${error.message}`, 'error');
                console.error('PDF generation error:', error);
            }
        }
    </script>
</body>
</html>