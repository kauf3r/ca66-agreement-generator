<!DOCTYPE html>
<html>
<head>
    <title>Position Testing - July29 Template</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; max-width: 900px; margin: 0 auto; }
        .test-section { background: #f8f9fa; padding: 20px; margin: 20px 0; border-radius: 8px; }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .warning { color: #ffc107; font-weight: bold; }
        button { background: #007bff; color: white; padding: 12px 24px; border: none; border-radius: 4px; cursor: pointer; margin: 5px; }
        button:hover { background: #0056b3; }
        #log { background: #ffffff; border: 1px solid #dee2e6; padding: 15px; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 400px; overflow-y: auto; }
        .download-link { background: #28a745; color: white; padding: 8px 16px; text-decoration: none; border-radius: 4px; display: inline-block; margin: 10px 5px; }
    </style>
</head>
<body>
    <h1>üéØ Position Testing - July29 Template</h1>
    
    <div class="test-section">
        <h2>üß™ Updated Position Configuration Test</h2>
        <p>Testing the updated maxWidth values to eliminate width constraint warnings.</p>
        <button onclick="testUpdatedPositions()">üöÄ Test Updated Positions</button>
        <button onclick="generateDebugPDF()">üîß Generate Debug PDF</button>
        <div id="test-results"></div>
    </div>
    
    <div class="test-section">
        <h2>üìä Console Log</h2>
        <div id="log"></div>
    </div>

    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script type="module">
        import { PDFLibGenerator } from './assets/js/pdf-lib-generator.js';
        import { PDFPositionConfig } from './assets/js/pdf-position-config.js';
        
        window.PDFLibGenerator = PDFLibGenerator;
        window.PDFPositionConfig = PDFPositionConfig;
        
        // Realistic test data matching the previous realistic data
        window.testData = {
            'licensee-name': 'John A. Smith',
            'phone': '(831) 555-0123',
            'email': 'john.smith@skywardaviation.com',
            'aircraft-registration': 'N847SA',
            'aircraft-make-model': 'Cessna 172S Skyhawk',
            'insurance-company': 'Avemco Insurance Company',
            'insurance-address': '411 Aviation Way',
            'insurance-city': 'Frederick',
            'insurance-state': 'MD',
            'insurance-zip': '21701',
            'insurance-phone': '(800) 638-8440',
            'policy-number': 'AV-2025-001847',
            'policy-expiry': '2025-12-31',
            'coverage-amount': 1000000,
            'start-date': '2025-02-01',
            'end-date': '2026-02-01'
        };
    </script>

    <script>
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
            logDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        async function testUpdatedPositions() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>üß™ Testing updated position configuration...</p>';
            
            try {
                log('Starting position test with updated maxWidth values...', 'info');
                
                const startTime = performance.now();
                const pdfBytes = await window.PDFLibGenerator.generateFilledPDF(window.testData);
                const endTime = performance.now();
                
                const duration = endTime - startTime;
                const size = Math.round(pdfBytes.length / 1024);
                
                log(`PDF generated: ${size}KB in ${duration.toFixed(2)}ms`, 'success');
                
                // Create download links
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                resultsDiv.innerHTML = `
                    <div class="success">‚úÖ Position Test Complete!</div>
                    <p><strong>PDF Size:</strong> ${size}KB</p>
                    <p><strong>Generation Time:</strong> ${duration.toFixed(2)}ms</p>
                    <p><strong>Performance:</strong> ${duration < 3000 ? '‚úÖ Good' : '‚ö†Ô∏è Slow'} (target: <3000ms)</p>
                    <a href="${url}" download="updated-positions-test.pdf" class="download-link">üíæ Download Test PDF</a>
                    <a href="${url}" target="_blank" class="download-link">üëÄ Preview PDF</a>
                    <p><em>Check the PDF for proper field positioning and no text overflow warnings in console.</em></p>
                `;
                
            } catch (error) {
                log(`Position test failed: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<div class="error">‚ùå Test failed: ${error.message}</div>`;
            }
        }

        async function generateDebugPDF() {
            const resultsDiv = document.getElementById('test-results');
            resultsDiv.innerHTML = '<p>üîß Generating debug PDF with position markers...</p>';
            
            try {
                log('Creating debug PDF with field position markers...', 'info');
                
                const { PDFDocument, rgb, StandardFonts } = PDFLib;
                
                // Load the template
                const templatePath = 'assets/examples/[TEMPLATE] New CA66 Monterey Bay Academy Airport License Agreement_July29.pdf';
                const response = await fetch(templatePath);
                const templateBytes = await response.arrayBuffer();
                const pdfDoc = await PDFDocument.load(templateBytes);
                
                // Get all pages
                const pages = pdfDoc.getPages();
                const font = await pdfDoc.embedFont(StandardFonts.Helvetica);
                
                log(`Processing ${pages.length} pages for debug markers...`, 'info');
                
                // Add position markers for each page
                pages.forEach((page, pageIndex) => {
                    const pageNumber = pageIndex + 1;
                    const { width, height } = page.getSize();
                    
                    // Add page number label
                    page.drawText(`Page ${pageNumber} - Updated Positions`, {
                        x: 10,
                        y: height - 20,
                        size: 12,
                        font: font,
                        color: rgb(0, 0, 1), // Blue
                    });
                    
                    // Get placeholders for this page
                    const placeholders = window.PDFPositionConfig.getPlaceholdersForPage(pageNumber);
                    
                    placeholders.forEach(({ placeholder, originalPlaceholder, x, y, size, maxWidth, description }) => {
                        const displayName = originalPlaceholder || placeholder;
                        
                        // Draw a red circle to mark the position
                        page.drawCircle({
                            x: x,
                            y: y,
                            size: 3,
                            color: rgb(1, 0, 0), // Red marker
                        });
                        
                        // Draw a rectangle to show the maxWidth area
                        page.drawRectangle({
                            x: x,
                            y: y - 2,
                            width: maxWidth,
                            height: size + 4,
                            borderColor: rgb(0, 1, 0), // Green border
                            borderWidth: 0.5,
                        });
                        
                        // Draw coordinate and width info
                        page.drawText(`${displayName}\\n(${x},${y}) w:${maxWidth}`, {
                            x: x + 5,
                            y: y + 8,
                            size: 6,
                            font: font,
                            color: rgb(1, 0, 0), // Red text
                        });
                    });
                });
                
                // Save and download
                const pdfBytes = await pdfDoc.save();
                const blob = new Blob([pdfBytes], { type: 'application/pdf' });
                const url = URL.createObjectURL(blob);
                
                resultsDiv.innerHTML = `
                    <div class="warning">üîß Debug PDF Generated</div>
                    <p>This PDF shows position markers (red circles) and maxWidth areas (green rectangles):</p>
                    <a href="${url}" download="position-debug.pdf" class="download-link">üíæ Download Debug PDF</a>
                    <a href="${url}" target="_blank" class="download-link">üëÄ Preview Debug PDF</a>
                    <p><small>Red circles = field positions, Green rectangles = maxWidth areas</small></p>
                `;
                
                log('Debug PDF ready for position analysis', 'success');
                
            } catch (error) {
                log(`Debug PDF generation failed: ${error.message}`, 'error');
                resultsDiv.innerHTML = `<div class="error">‚ùå Debug generation failed: ${error.message}</div>`;
            }
        }
    </script>
</body>
</html>